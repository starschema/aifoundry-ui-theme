name: Release

on:
  push:
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  id-token: write

env:
  # Artifact Registry path (host + project/repo)
  REGISTRY_PATH: us-central1-npm.pkg.dev/datadlc/aifoundry-ui-theme
  REGISTRY_HOST: us-central1-npm.pkg.dev
  WORKLOAD_IDENTITY_PROVIDER: projects/713235407853/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions
  SERVICE_ACCOUNT: sa-ci-publisher-datadlc-iam-gs@datadlc.iam.gserviceaccount.com

jobs:
  build-and-publish:
    name: Build and publish to Artifact Registry
    runs-on: [self-hosted, ai-foundry]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: master

      - name: Authenticate to Google Cloud (Workload Identity)
        uses: google-github-actions/auth@v1
        with:
          token_format: "access_token"
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Install Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"

      - name: Extract version from tag and update package.json
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          # Extract version from tag (remove 'v' prefix)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Version from tag: $VERSION"
          
          # Update package.json version
          npm version $VERSION --no-git-tag-version --allow-same-version
          
          echo "Updated package.json to version $VERSION"
      - name: Configure npm for Artifact Registry
        # This writes the access token to npm config so `npm publish` can authenticate
        run: |
          echo "Configuring npm to publish to Artifact Registry: https://${{ env.REGISTRY_PATH }}"
          ACCESS_TOKEN=$(gcloud auth print-access-token)
          # Configure npm to use Artifact Registry for @hcl scope with full repository path
          npm config set @hcl:registry "https://${{ env.REGISTRY_PATH }}/"
          npm config set //${{ env.REGISTRY_PATH }}/:_authToken "$ACCESS_TOKEN"


      - name: Install dependencies
        run: npm ci

      - name: Build package
        run: npm run build

      - name: Add built theme files to git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          # Skip if there is no change in the dist folder
          if git diff --quiet -- dist/; then
            echo "No changes in dist folder"
            exit 0  # Exit successfully if no changes
          fi
          git add dist
          git commit -m "new build added"
          git push

      - name: Publish to Artifact Registry
        run: |
          echo "Publishing to Artifact Registry: https://${{ env.REGISTRY_HOST }}/"
          npm publish
          
      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha

      - name: Add version-based dist-tags
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          # Extract version from tag
          PACKAGE_NAME="@hcl/aifoundry-ui-theme"
          VERSION=${GITHUB_REF#refs/tags/v}
          TAGS=${{ steps.meta.outputs.tags }}
          
          echo "Adding dist-tags for version $VERSION"

          for tag in "${TAGS[@]}"; do
            npm dist-tag add ${PACKAGE_NAME}@${VERSION} ${tag}
            echo "Tag added: ${tag}"
          done
          

      - name: Publish note on failure
        if: failure()
        run: |
          echo "Publish step failed â€” verify the service account has Artifact Registry Writer role and the WORKLOAD_IDENTITY_PROVIDER is configured."
